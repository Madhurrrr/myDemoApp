name: Deploy AKS using Terraform

on:
  push:
    branches:
      - master

#jobs:
#  terraform:
#    name: Set Terraform Variables
#    env:
##      AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}
#      ARM_CLIENT_ID: ${{secrets.ARM_CLIENT_ID}}
#      ARM_CLIENT_SECRET: ${{secrets.ARM_CLIENT_SECRET}}
#      ARM_SUBSCRIPTION_ID: ${{secrets.ARM_SUBSCRIPTION_ID}}
#      ARM_TENANT_ID: ${{secrets.ARM_TENANT_ID}}
#    runs-on: ubuntu-latest
#    environment: production
#    defaults:
#      run:
#        shell: bash
#
#
#    steps:
#      - name: Checkout repository
#        uses: actions/checkout@v3
#
#      - name: Set up Terraform
#        uses: hashicorp/setup-terraform@v1

#      - name: Azure login
#        uses: azure/login@v1
#        with:
#          creds: ${{ secrets.AZURE_CREDENTIALS }}

#      - name: Terraform Init
#        run: terraform init
#        working-directory: ./terraform

#      - name: Terraform Format
#        run: terraform fmt -check
#        working-directory: ./terraform
#
#      - name: Terraform Plan
#        run: terraform plan -input=false
#        working-directory: ./terraform
#
#      - name: Terraform Apply
#        run: terraform apply -auto-approve
#        working-directory: ./terraform


jobs:
  terraform:
    name: 'Terraform'
    env:
      ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
      ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
      ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
      ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
    runs-on: ubuntu-latest
    environment: production

    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v1

      - name: Terraform Init
        working-directory: ./terraform
        run: terraform init

      - name: Terraform Format
        working-directory: ./terraform
        run: terraform fmt

      - name: Terraform Plan
        working-directory: ./terraform
        run: terraform plan

      - name: Terraform Apply
        working-directory: ./terraform
        run: terraform apply -auto-approve